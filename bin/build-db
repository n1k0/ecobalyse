#!/usr/bin/env node

/**
 * This script generates JSON Db fixtures so tests can perform assertions
 * against actual JSON data without having to rely on Http requests, which
 * is impossible in an Elm test environment.
 */
const fs = require("fs");
const textileProcesses = process.env.TEXTILE_PROCESSES || "public/data/textile/processes.json";
const foodProcesses = process.env.FOOD_PROCESSES || "public/data/food/processes.json";
console.log("textileProcesses", textileProcesses);
const targetDbFile = process.env.STATIC_DB || "src/Static/Db.elm"

function getJson(path) {
  return JSON.parse(fs.readFileSync(path).toString());
}

/**
 * Adapts a standard JSON string to what is expected to be the format
 * used in Elm's template strings (`"""{}"""`).
 */
function serializeForElmTemplateString(toStringify) {
  return JSON.stringify(toStringify).replaceAll("\\", "\\\\");
}

function buildTextileProcessesJsonDb() {
  return serializeForElmTemplateString(getJson(textileProcesses));
}

function buildTextileJsonDb(basePath = "public/data") {
  return serializeForElmTemplateString({
    // common data
    countries: getJson(`${basePath}/countries.json`),
    impacts: getJson(`${basePath}/impacts.json`),
    transports: getJson(`${basePath}/transports.json`),
    // textile data
    materials: getJson(`${basePath}/textile/materials.json`),
    products: getJson(`${basePath}/textile/products.json`),
  });
}

function buildFoodProcessesJsonDb() {
  return serializeForElmTemplateString(getJson(foodProcesses));
}

function buildFoodIngredientsJsonDb(basePath = "public/data/food") {
  return serializeForElmTemplateString(getJson(`${basePath}/ingredients.json`));
}

const elmTemplate = fs.readFileSync(`${targetDbFile}-template`).toString();
const elmWithFixtures = elmTemplate
  .replace("%textileProcessesJson%", buildTextileProcessesJsonDb())
  .replace("%textileJson%", buildTextileJsonDb())
  .replace("%foodProcessesJson%", buildFoodProcessesJsonDb())
  .replace("%foodIngredientsJson%", buildFoodIngredientsJsonDb());

const header =
  "---- THIS FILE WAS GENERATED FROM THE FILE `Db.elm-template` BY THE `/bin/build-db` SCRIPT";

try {
  fs.writeFileSync(targetDbFile, `${header}\n\n${elmWithFixtures}`);
  const fileSizeInKB = Math.ceil(fs.statSync(targetDbFile).size / 1024);
  console.log(`Successfully generated Elm static database at ${targetDbFile} (${fileSizeInKB}Â KB)`);
} catch (err) {
  throw new Error(`Unable to generate Elm static database: ${err}`);
}
